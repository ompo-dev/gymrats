// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTENTICAÇÃO E USUÁRIOS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String? // Opcional: usuários Google não têm senha
  name          String
  emailVerified Boolean? // Better Auth usa boolean, não DateTime
  image         String?
  role          UserRole  @default(STUDENT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relacionamentos
  student        Student?
  gyms           Gym[] // Um usuário pode ter várias academias
  activeGymId    String? // Academia atualmente selecionada
  accounts       Account[]
  sessions       Session[]
  gymPreference  GymUserPreference? // Preferências do usuário para academias
  paymentMethods PaymentMethod[] // Métodos de pagamento salvos

  @@map("users")
}

enum UserRole {
  STUDENT
  GYM
  ADMIN
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String?
  provider          String?  // Temporariamente opcional para compatibilidade com Better Auth
  providerAccountId String?  // Temporariamente opcional para compatibilidade com Better Auth
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  // Campos Better Auth (adicionados para compatibilidade)
  accountId         String?  // Mapeado de providerAccountId
  providerId         String?  // Mapeado de provider
  accessToken        String?  // Mapeado de access_token
  refreshToken       String?  // Mapeado de refresh_token
  accessTokenExpiresAt DateTime? // Calculado de expires_at
  idToken           String?  // Mapeado de id_token
  
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId], name: "accounts_provider_providerAccountId_key")
  @@map("accounts")
}

model Session {
  id        String    @id @default(cuid())
  token     String    @unique // Better Auth usa 'token', não 'sessionToken'
  userId    String
  expiresAt DateTime  // Better Auth usa 'expiresAt', não 'expires'
  ipAddress String?   // Opcional: IP do usuário
  userAgent String?   // Opcional: User agent do navegador
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Campos legacy (mantidos para compatibilidade durante transição)
  sessionToken String? // Mantido para compatibilidade, mapeado de token
  expires      DateTime? // Mantido para compatibilidade, mapeado de expiresAt

  @@map("sessions")
}

// Modelo antigo (mantido para compatibilidade, pode ser removido depois)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Modelo Better Auth - Verification
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ============================================
// ALUNOS (STUDENTS)
// ============================================

model Student {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  age          Int?
  gender       String?
  phone        String?
  avatar       String?
  // Informações sobre identidade de gênero e terapia hormonal
  isTrans      Boolean? // Se a pessoa é transgênero
  usesHormones Boolean? // Se faz uso de terapia hormonal
  hormoneType  String? // "testosterone" | "estrogen" | "none"

  // Progresso
  progress StudentProgress?

  // Perfil
  profile StudentProfile?

  // Histórico
  workouts        WorkoutHistory[]
  workoutProgress WorkoutProgress[] // Progresso parcial de workouts
  records         PersonalRecord[]
  diets           DietPlanCompletion[]
  achievements    AchievementUnlock[]
  weightHistory   WeightHistory[]
  dailyNutrition  DailyNutrition[]

  // Treinos personalizados
  units Unit[]

  // Academias
  memberships GymMembership[]
  dayPasses   DayPass[]

  // Social
  friends  Friendship[] @relation("UserFriends")
  friendOf Friendship[] @relation("FriendOf")

  // Assinatura
  subscription Subscription?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("students")
}

model StudentProgress {
  id                String    @id @default(cuid())
  studentId         String    @unique
  student           Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  currentStreak     Int       @default(0)
  longestStreak     Int       @default(0)
  totalXP           Int       @default(0)
  currentLevel      Int       @default(1)
  xpToNextLevel     Int       @default(100)
  workoutsCompleted Int       @default(0)
  lastActivityDate  DateTime?
  dailyGoalXP       Int       @default(100)
  todayXP           Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("student_progress")
}

model StudentProfile {
  id                       String  @id @default(cuid())
  studentId                String  @unique
  student                  Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  height                   Float? // cm
  weight                   Float? // kg (peso atual - último registro de WeightHistory)
  fitnessLevel             String? // iniciante, intermediario, avancado
  weeklyWorkoutFrequency   Int?
  workoutDuration          Int? // minutos
  goals                    String? // JSON array
  injuries                 String? // JSON array
  availableEquipment       String? // JSON array
  gymType                  String?
  preferredWorkoutTime     String?
  preferredSets            Int?
  preferredRepRange        String?
  restTime                 String?
  dietType                 String?
  allergies                String? // JSON array
  targetCalories           Int?
  targetProtein            Float?
  targetCarbs              Float?
  targetFats               Float?
  mealsPerDay              Int?
  // Valores metabólicos calculados
  bmr                      Float? // Taxa metabólica basal (Basal Metabolic Rate)
  tdee                     Float? // Gasto energético total diário (Total Daily Energy Expenditure)
  // Nível de atividade física (1-10) baseado em Harris-Benedict
  activityLevel            Int? // 1-10
  // Tempo de tratamento hormonal (meses)
  hormoneTreatmentDuration Int? // Meses de tratamento hormonal
  // Limitações separadas (JSON arrays)
  physicalLimitations      String? // JSON array de limitações físicas
  motorLimitations         String? // JSON array de limitações motoras
  medicalConditions        String? // JSON array de condições médicas
  // Detalhes adicionais das limitações (JSON object)
  limitationDetails        String? // JSON object: { "limitationKey": "detailValue" }
  // Horas disponíveis por dia para treino (para planejamento de treino mensal)
  dailyAvailableHours      Float? // 0.5, 1, 1.5, 2, etc (horas por dia)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("student_profiles")
}

model WeightHistory {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  weight    Float // kg
  date      DateTime @default(now())
  notes     String? // Anotações opcionais

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, date])
  @@map("weight_history")
}

// ============================================
// ACADEMIAS (GYMS)
// ============================================

model Gym {
  id       String  @id @default(cuid())
  userId   String // Removido unique - agora um user pode ter várias gyms
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name     String
  logo     String?
  address  String
  phone    String
  email    String
  cnpj     String? @unique
  plan     String  @default("basic") // basic, premium, enterprise
  isActive Boolean @default(true) // Se a academia está ativa

  // Novos campos para localização e informações
  latitude     Float? // Latitude
  longitude    Float? // Longitude
  rating       Float?  @default(0) // Rating médio (0-5)
  totalReviews Int     @default(0) // Total de avaliações
  amenities    String? // JSON array de amenidades
  openingHours String? // JSON: { open: "06:00", close: "23:00", days: ["monday", "tuesday", ...] }
  photos       String? // JSON array de URLs de fotos
  isPartner    Boolean @default(false) // Se está cadastrado como parceiro no GymRats

  // Relacionamentos
  profile      GymProfile?
  students     GymMembership[]
  equipment    Equipment[]
  plans        MembershipPlan[]
  payments     Payment[]
  expenses     Expense[]
  checkIns     CheckIn[]
  stats        GymStats?
  subscription GymSubscription?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([latitude, longitude]) // Para busca por localização
  @@map("gyms")
}

model GymProfile {
  id             String @id @default(cuid())
  gymId          String @unique
  gym            Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  totalStudents  Int    @default(0)
  activeStudents Int    @default(0)
  equipmentCount Int    @default(0)

  // Gamificação
  level                Int    @default(1)
  xp                   Int    @default(0)
  xpToNextLevel        Int    @default(100)
  currentStreak        Int    @default(0)
  longestStreak        Int    @default(0)
  monthlyStudentGoal   Int?
  avgStudentFrequency  Float?
  equipmentUtilization Float?
  ranking              Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gym_profiles")
}

model GymStats {
  id                   String @id @default(cuid())
  gymId                String @unique
  gym                  Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  todayCheckins        Int    @default(0)
  todayActiveStudents  Int    @default(0)
  todayEquipmentInUse  Int    @default(0)
  weekTotalCheckins    Int    @default(0)
  weekAvgDailyCheckins Float  @default(0)
  weekNewMembers       Int    @default(0)
  weekCanceledMembers  Int    @default(0)
  monthTotalCheckins   Int    @default(0)
  monthRetentionRate   Float  @default(0)
  monthGrowthRate      Float  @default(0)

  updatedAt DateTime @updatedAt

  @@map("gym_stats")
}

// ============================================
// TREINOS (WORKOUTS)
// ============================================

model Unit {
  id          String   @id @default(cuid())
  title       String
  description String?
  color       String?
  icon        String?
  order       Int      @default(0)
  studentId   String? // Se null, é um treino global; se preenchido, é personalizado para o aluno
  student     Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)

  workouts Workout[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("units")
}

model Workout {
  id            String  @id @default(cuid())
  unitId        String?
  unit          Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)
  title         String
  description   String?
  type          String  @default("strength") // strength, cardio, flexibility, rest
  muscleGroup   String
  difficulty    String
  xpReward      Int     @default(10)
  estimatedTime Int // minutos
  order         Int     @default(0)
  locked        Boolean @default(true)

  exercises   WorkoutExercise[]
  completions WorkoutHistory[]
  progress    WorkoutProgress[] // Progresso parcial de workouts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workouts")
}

model WorkoutExercise {
  id            String  @id @default(cuid())
  workoutId     String
  workout       Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  name          String
  sets          Int
  reps          String // "12" ou "12-15" ou "30s"
  rest          Int // segundos
  notes         String?
  videoUrl      String?
  educationalId String? // Referência ao conteúdo educacional
  order         Int     @default(0)

  // Dados do educational database
  primaryMuscles     String? // JSON array de músculos primários
  secondaryMuscles   String? // JSON array de músculos secundários
  difficulty         String? // "iniciante" | "intermediario" | "avancado"
  equipment          String? // JSON array de equipamentos necessários
  instructions       String? // JSON array de instruções passo a passo
  tips               String? // JSON array de dicas
  commonMistakes     String? // JSON array de erros comuns
  benefits           String? // JSON array de benefícios
  scientificEvidence String? // Texto com evidência científica

  alternatives AlternativeExercise[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workout_exercises")
}

model AlternativeExercise {
  id                String          @id @default(cuid())
  workoutExerciseId String
  workoutExercise   WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)
  name              String
  reason            String // Motivo da alternativa (ex: "Equipamento diferente", "Sem equipamento")
  educationalId     String? // Referência ao conteúdo educacional
  order             Int             @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("alternative_exercises")
}

model WorkoutProgress {
  id                   String   @id @default(cuid())
  studentId            String
  student              Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  workoutId            String
  workout              Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  currentExerciseIndex Int      @default(0)
  exerciseLogs         String // JSON array de ExerciseLog
  skippedExercises     String? // JSON array de IDs de exercícios pulados
  selectedAlternatives String? // JSON object: exerciseId -> alternativeId
  xpEarned             Int      @default(0)
  totalVolume          Float    @default(0)
  completionPercentage Float    @default(0)
  startTime            DateTime @default(now())
  cardioPreference     String? // "none", "before", "after"
  cardioDuration       Int? // minutos (5, 10, 15, 20)
  selectedCardioType   String? // tipo de cardio selecionado

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, workoutId])
  @@index([studentId])
  @@index([workoutId])
  @@map("workout_progress")
}

model WorkoutHistory {
  id                String   @id @default(cuid())
  studentId         String
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  workoutId         String?
  workout           Workout? @relation(fields: [workoutId], references: [id], onDelete: SetNull)
  date              DateTime @default(now())
  duration          Int // minutos
  totalVolume       Float? // kg total
  overallFeedback   String?
  bodyPartsFatigued String? // JSON array

  exercises ExerciseLog[]
  records   PersonalRecord[]

  createdAt DateTime @default(now())

  @@map("workout_history")
}

model ExerciseLog {
  id               String         @id @default(cuid())
  workoutHistoryId String
  workoutHistory   WorkoutHistory @relation(fields: [workoutHistoryId], references: [id], onDelete: Cascade)
  exerciseId       String
  exerciseName     String
  sets             String // JSON array de SetLog
  notes            String?
  formCheckScore   Int?
  difficulty       String?

  @@map("exercise_logs")
}

model PersonalRecord {
  id               String          @id @default(cuid())
  studentId        String
  student          Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  workoutHistoryId String?
  workoutHistory   WorkoutHistory? @relation(fields: [workoutHistoryId], references: [id])
  exerciseId       String
  exerciseName     String
  type             String // max-weight, max-reps, max-volume
  value            Float
  date             DateTime        @default(now())
  previousBest     Float?

  @@map("personal_records")
}

// ============================================
// DIETAS
// ============================================

model DietPlan {
  id            String  @id @default(cuid())
  title         String
  description   String?
  totalCalories Int
  targetProtein Float
  targetCarbs   Float
  targetFats    Float
  xpReward      Int     @default(5)
  locked        Boolean @default(true)
  order         Int     @default(0)

  meals       Meal[]
  completions DietPlanCompletion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("diet_plans")
}

model Meal {
  id          String   @id @default(cuid())
  dietPlanId  String
  dietPlan    DietPlan @relation(fields: [dietPlanId], references: [id], onDelete: Cascade)
  name        String
  type        String // breakfast, lunch, dinner, snack
  calories    Int
  protein     Float
  carbs       Float
  fats        Float
  time        String?
  image       String?
  ingredients String? // JSON array
  order       Int      @default(0)

  @@map("meals")
}

model DietPlanCompletion {
  id         String   @id @default(cuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  dietPlanId String
  dietPlan   DietPlan @relation(fields: [dietPlanId], references: [id])
  date       DateTime @default(now())
  completed  Boolean  @default(false)

  @@map("diet_plan_completions")
}

// ============================================
// NUTRIÇÃO DIÁRIA
// ============================================

model DailyNutrition {
  id          String   @id @default(cuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  date        DateTime @default(now())
  waterIntake Int      @default(0) // ml

  meals NutritionMeal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, date])
  @@index([studentId, date])
  @@map("daily_nutrition")
}

model NutritionMeal {
  id               String         @id @default(cuid())
  dailyNutritionId String
  dailyNutrition   DailyNutrition @relation(fields: [dailyNutritionId], references: [id], onDelete: Cascade)
  name             String
  type             String // breakfast, lunch, dinner, snack
  calories         Int
  protein          Float
  carbs            Float
  fats             Float
  time             String?
  completed        Boolean        @default(false)

  foods NutritionFoodItem[]

  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("nutrition_meals")
}

model NutritionFoodItem {
  id              String        @id @default(cuid())
  nutritionMealId String
  nutritionMeal   NutritionMeal @relation(fields: [nutritionMealId], references: [id], onDelete: Cascade)
  foodId          String? // Referência a food database
  foodName        String
  servings        Float
  calories        Int
  protein         Float
  carbs           Float
  fats            Float
  servingSize     String

  createdAt DateTime @default(now())

  @@map("nutrition_food_items")
}

model FoodItem {
  id          String  @id @default(cuid())
  name        String
  calories    Int // por 100g ou por porção padrão
  protein     Float
  carbs       Float
  fats        Float
  servingSize String // "100g" ou "1 unidade (50g)"
  category    String // protein, carbs, vegetables, fruits, fats, dairy, snacks
  image       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([category])
  @@map("food_items")
}

// ============================================
// CONQUISTAS
// ============================================

model Achievement {
  id          String  @id @default(cuid())
  title       String
  description String?
  icon        String?
  category    String
  level       Int?
  color       String?
  target      Int?
  xpReward    Int     @default(0)

  unlocks AchievementUnlock[]

  createdAt DateTime @default(now())

  @@map("achievements")
}

model AchievementUnlock {
  id            String      @id @default(cuid())
  studentId     String
  student       Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  progress      Int?
  unlockedAt    DateTime    @default(now())

  @@map("achievement_unlocks")
}

// Preferências do usuário para múltiplas academias
model GymUserPreference {
  id              String  @id @default(cuid())
  userId          String  @unique
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastActiveGymId String? // Última academia acessada

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gym_user_preferences")
}

// ============================================
// ACADEMIAS - MEMBROS
// ============================================

model GymMembership {
  id              String          @id @default(cuid())
  gymId           String
  gym             Gym             @relation(fields: [gymId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  planId          String?
  plan            MembershipPlan? @relation(fields: [planId], references: [id])
  startDate       DateTime        @default(now())
  nextBillingDate DateTime?
  amount          Float
  status          String          @default("active") // active, suspended, canceled, pending
  autoRenew       Boolean         @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gym_memberships")
}

model MembershipPlan {
  id       String  @id @default(cuid())
  gymId    String
  gym      Gym     @relation(fields: [gymId], references: [id], onDelete: Cascade)
  name     String
  type     String // monthly, quarterly, semi-annual, annual, trial
  price    Float
  duration Int // dias
  benefits String? // JSON array
  isActive Boolean @default(true)

  memberships GymMembership[]
  payments    Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("membership_plans")
}

model DayPass {
  id           String   @id @default(cuid())
  studentId    String
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  gymId        String
  gymName      String
  purchaseDate DateTime @default(now())
  validDate    DateTime
  price        Float
  status       String   @default("active") // active, used, expired
  qrCode       String?

  @@map("day_passes")
}

model CheckIn {
  id          String    @id @default(cuid())
  gymId       String
  gym         Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  studentId   String
  studentName String
  timestamp   DateTime  @default(now())
  checkOut    DateTime?
  duration    Int? // minutos

  @@map("check_ins")
}

// ============================================
// EQUIPAMENTOS
// ============================================

model Equipment {
  id               String    @id @default(cuid())
  gymId            String
  gym              Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  name             String
  type             String
  brand            String?
  model            String?
  serialNumber     String?   @unique
  purchaseDate     DateTime?
  lastMaintenance  DateTime?
  nextMaintenance  DateTime?
  status           String    @default("available") // available, in-use, maintenance, broken
  currentUserId    String?
  currentUserName  String?
  currentStartTime DateTime?
  qrCode           String?

  maintenanceHistory MaintenanceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("equipment")
}

model MaintenanceRecord {
  id            String    @id @default(cuid())
  equipmentId   String
  equipment     Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  date          DateTime  @default(now())
  type          String // preventive, corrective, inspection
  description   String?
  performedBy   String?
  cost          Float?
  nextScheduled DateTime?

  @@map("maintenance_records")
}

// ============================================
// FINANCEIRO
// ============================================

model Payment {
  id            String          @id @default(cuid())
  gymId         String
  gym           Gym             @relation(fields: [gymId], references: [id], onDelete: Cascade)
  studentId     String
  studentName   String
  planId        String?
  plan          MembershipPlan? @relation(fields: [planId], references: [id])
  amount        Float
  date          DateTime        @default(now())
  dueDate       DateTime
  status        String          @default("pending") // paid, pending, overdue, canceled
  paymentMethod String?
  reference     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payments")
}

model Expense {
  id          String   @id @default(cuid())
  gymId       String
  gym         Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  type        String // maintenance, equipment, staff, utilities, rent, other
  description String?
  amount      Float
  date        DateTime @default(now())
  category    String?

  createdAt DateTime @default(now())

  @@map("expenses")
}

model PaymentMethod {
  id          String  @id @default(cuid())
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String // credit-card, debit-card, pix
  isDefault   Boolean @default(false)
  cardBrand   String? // visa, mastercard, elo, etc
  last4       String? // Últimos 4 dígitos do cartão
  expiryMonth Int?
  expiryYear  Int?
  holderName  String?
  pixKey      String? // Chave PIX (CPF, email, telefone, chave aleatória)
  pixKeyType  String? // cpf, email, phone, random

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("payment_methods")
}

// ============================================
// SOCIAL
// ============================================

model Friendship {
  id        String   @id @default(cuid())
  userId    String
  user      Student  @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friendId  String
  friend    Student  @relation("FriendOf", fields: [friendId], references: [id], onDelete: Cascade)
  status    String   @default("pending") // pending, accepted, blocked
  createdAt DateTime @default(now())

  @@unique([userId, friendId])
  @@map("friendships")
}

// ============================================
// ASSINATURAS E MONETIZAÇÃO
// ============================================

// Assinaturas de Alunos (Premium)
model Subscription {
  id                 String    @id @default(cuid())
  studentId          String    @unique
  student            Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  plan               String    @default("free") // free, premium
  status             String    @default("active") // active, canceled, expired, past_due, trialing
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?
  trialStart         DateTime?
  trialEnd           DateTime?

  // Gateway de pagamento (AbacatePay)
  abacatePayBillingId  String? @unique // ID da cobrança na AbacatePay
  abacatePayCustomerId String? // ID do cliente na AbacatePay

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

// Assinaturas de Academias
model GymSubscription {
  id                 String    @id @default(cuid())
  gymId              String    @unique
  gym                Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  plan               String // basic, premium, enterprise
  billingPeriod      String    @default("monthly") // monthly, annual
  status             String    @default("active") // active, canceled, expired, past_due, trialing
  basePrice          Float // Preço fixo mensal ou anual
  pricePerStudent    Float // Preço por aluno/mês (apenas para plano mensal, 0 para anual)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?
  trialStart         DateTime?
  trialEnd           DateTime?

  // Gateway de pagamento (AbacatePay)
  abacatePayBillingId  String? @unique // ID da cobrança na AbacatePay
  abacatePayCustomerId String? // ID do cliente na AbacatePay

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gym_subscriptions")
}

// Features Premium disponíveis
model SubscriptionFeature {
  id          String  @id @default(cuid())
  featureKey  String  @unique // "ai_workout", "ai_diet", "posture_analysis", "coach", "nutrition", "advanced_reports"
  name        String
  description String?
  category    String // "ai", "coach", "nutrition", "reports", "education"
  icon        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscription_features")
}

// Histórico de pagamentos de assinaturas
model SubscriptionPayment {
  id                  String    @id @default(cuid())
  subscriptionId      String? // Pode ser de aluno ou academia
  gymSubscriptionId   String?
  amount              Float
  currency            String    @default("BRL")
  status              String // succeeded, pending, failed, refunded
  paymentMethod       String? // credit_card, debit_card, pix, boleto
  abacatePayBillingId String?   @unique // ID da cobrança na AbacatePay
  paidAt              DateTime?
  failedAt            DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscription_payments")
}
